---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "wordpress.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    release: {{ include "wordpress.fullname" . }}
type: Opaque
data:
  WORDPRESS_TABLE_PREFIX: {{ .Values.wordpress.tablePrefix | b64enc }}
  {{- if .Values.wordpress.configExtraInject }}
  {{/* Build inject string: WP_HOME, WP_SITEURL, memcached config */}}
  {{- $inject := "" }}
  {{- $url := include "wordpress.normalizedUrl" . }}
  {{/* Always inject WP_HOME and WP_SITEURL (URL is auto-prefixed with http/https if no protocol given) */}}
  {{- $inject = printf "define('WP_HOME', '%s');define('WP_SITEURL', '%s');" $url $url }}
  {{/* Multisite constants (WP_ALLOW_MULTISITE, MULTISITE, SUBDOMAIN_INSTALL, DOMAIN_CURRENT_SITE, etc.) */}}
  {{/* are NOT injected here. They are written directly into wp-config.php by 'wp core multisite-convert' */}}
  {{/* in the init container and persist on the PVC. Injecting them here would cause PHP warnings */}}
  {{/* about already-defined constants. */}}
  {{- include "wordpress.cache.validateSelection" . }}
  {{- $cacheBackends := (include "wordpress.cache.backends" . | fromYaml) }}
  {{- /* Add cache config for the selected backend (exactly one backend can be enabled) */}}
  {{- if and (eq $cacheBackends.selected "memcached") $cacheBackends.memcachedCreateConfig }}
  {{- $inject = printf "%sif (!defined('WP_CACHE')) { define('WP_CACHE', true); }" $inject }}
  {{- $cacheKeySalt := (include "wordpress.cache.resolveSalt" (dict
        "ctx" .
        "backend" "memcached"
        "valueSalt" (.Values.memcached.cacheKeySalt | default "")
        "secretName" .Values.memcached.cacheKeySaltSecret.name
        "secretKey" (.Values.memcached.cacheKeySaltSecret.key | default "WP_CACHE_KEY_SALT")
      ) | fromYaml).salt }}
  WORDPRESS_CACHE_KEY_SALT: {{ $cacheKeySalt | b64enc }}
  {{- $inject = printf "%sdefine('WP_CACHE_KEY_SALT', '%s');" $inject (replace "'" "\\'" $cacheKeySalt) }}
  {{- $memcachedServerGroups := .Values.memcached.serverGroups | default dict }}
  {{- $memcfg := "" }}
  {{- if gt (len $memcachedServerGroups) 0 }}
  {{- $groupEntries := list }}
  {{- range $groupName, $groupServers := $memcachedServerGroups }}
  {{- $serverEntries := list }}
  {{- range $groupServers }}
  {{- $serverEntries = append $serverEntries (printf "'%s'" .) }}
  {{- end }}
  {{- $groupEntries = append $groupEntries (printf "'%s' => array(%s)" $groupName (join ", " $serverEntries)) }}
  {{- end }}
  {{- $memcfg = printf "$memcached_servers = array(%s);\n" (join ", " $groupEntries) }}
  {{- else }}
  {{- $memcfg = printf "$memcached_servers = array('default' => array('%s:%v'));\n" (include "wordpress.memcached.fullname" .) (.Values.memcached.service.port) }}
  {{- end }}
  {{- $inject = printf "%s%s" $inject $memcfg }}
  {{- else if or (eq $cacheBackends.selected "redis") (eq $cacheBackends.selected "valkey") }}
  {{- $cacheMeta := (include "wordpress.cache.kvMeta" (dict "ctx" . "backend" $cacheBackends.selected) | fromYaml) }}
  {{- if $cacheMeta.createConfig }}
  {{- $inject = printf "%sif (!defined('WP_CACHE')) { define('WP_CACHE', true); }" $inject }}
  {{- $cacheKeySalt := (include "wordpress.cache.resolveSalt" (dict
        "ctx" .
        "backend" $cacheMeta.backend
        "valueSalt" $cacheMeta.cacheKeySalt
        "secretName" $cacheMeta.cacheKeySaltSecretName
        "secretKey" $cacheMeta.cacheKeySaltSecretKey
      ) | fromYaml).salt }}
  WORDPRESS_CACHE_KEY_SALT: {{ $cacheKeySalt | b64enc }}
  {{- $inject = printf "%sdefine('WP_CACHE_KEY_SALT', '%s');" $inject (replace "'" "\\'" $cacheKeySalt) }}
  {{- $scaling := ($cacheMeta.scaling | default dict) }}
  {{- $scalingType := (default "none" $scaling.type) }}
  {{- if eq $scalingType "none" }}
  {{- $inject = printf "%sdefine('WP_REDIS_HOST', '%s');define('WP_REDIS_PORT', %v);" $inject $cacheMeta.host $cacheMeta.port }}
  {{- else if eq $scalingType "replication" }}
  {{- $servers := ($scaling.servers | default list) }}
  {{- if eq (len $servers) 0 }}{{- fail (printf "%s.scaling.type=replication requires %s.scaling.servers with at least one entry" $cacheMeta.backend $cacheMeta.backend) }}{{- end }}
  {{- $serverEntries := list }}
  {{- range $servers }}
  {{- $serverEntries = append $serverEntries (printf "'%s'" (replace "'" "\\'" .)) }}
  {{- end }}
  {{- $inject = printf "%sdefine('WP_REDIS_CLIENT', 'predis');define('WP_REDIS_SERVERS', array(%s));" $inject (join ", " $serverEntries) }}
  {{- else if eq $scalingType "sharding" }}
  {{- $shards := ($scaling.shards | default list) }}
  {{- if eq (len $shards) 0 }}{{- fail (printf "%s.scaling.type=sharding requires %s.scaling.shards with at least one entry" $cacheMeta.backend $cacheMeta.backend) }}{{- end }}
  {{- $shardEntries := list }}
  {{- range $shards }}
  {{- $shardEntries = append $shardEntries (printf "'%s'" (replace "'" "\\'" .)) }}
  {{- end }}
  {{- $inject = printf "%sdefine('WP_REDIS_CLIENT', 'phpredis');define('WP_REDIS_SHARDS', array(%s));" $inject (join ", " $shardEntries) }}
  {{- else if eq $scalingType "sentinel" }}
  {{- $servers := ($scaling.servers | default list) }}
  {{- $sentinel := ($scaling.sentinel | default "") }}
  {{- if eq (len $servers) 0 }}{{- fail (printf "%s.scaling.type=sentinel requires %s.scaling.servers with at least one entry" $cacheMeta.backend $cacheMeta.backend) }}{{- end }}
  {{- if eq $sentinel "" }}{{- fail (printf "%s.scaling.type=sentinel requires %s.scaling.sentinel" $cacheMeta.backend $cacheMeta.backend) }}{{- end }}
  {{- $serverEntries := list }}
  {{- range $servers }}
  {{- $serverEntries = append $serverEntries (printf "'%s'" (replace "'" "\\'" .)) }}
  {{- end }}
  {{- $inject = printf "%sdefine('WP_REDIS_CLIENT', 'predis');define('WP_REDIS_SENTINEL', '%s');define('WP_REDIS_SERVERS', array(%s));" $inject (replace "'" "\\'" $sentinel) (join ", " $serverEntries) }}
  {{- else if eq $scalingType "cluster" }}
  {{- $cluster := ($scaling.cluster | default list) }}
  {{- if eq (len $cluster) 0 }}{{- fail (printf "%s.scaling.type=cluster requires %s.scaling.cluster with at least one entry" $cacheMeta.backend $cacheMeta.backend) }}{{- end }}
  {{- $clusterEntries := list }}
  {{- range $cluster }}
  {{- $clusterEntries = append $clusterEntries (printf "'%s'" (replace "'" "\\'" .)) }}
  {{- end }}
  {{- $inject = printf "%sdefine('WP_REDIS_CLIENT', 'phpredis');define('WP_REDIS_CLUSTER', array(%s));" $inject (join ", " $clusterEntries) }}
  {{- else }}
  {{- fail (printf "%s.scaling.type '%s' is invalid. Supported: none, replication, sharding, sentinel, cluster" $cacheMeta.backend $scalingType) }}
  {{- end }}
  {{- if $cacheMeta.authEnabled }}
  {{- $inject = printf "%sif (getenv('WP_REDIS_PASSWORD') !== false && getenv('WP_REDIS_PASSWORD') !== '') { define('WP_REDIS_PASSWORD', getenv('WP_REDIS_PASSWORD')); }" $inject }}
  {{- end }}
  {{- end }}
  {{- end }}
  {{- if and (not .Values.wordpress.configExtraConfigMap.name) (not .Values.wordpress.configExtraSecret.name) }}
  {{/* No external source: combine user configExtra (if any) + inject into WORDPRESS_CONFIG_EXTRA */}}
  {{- $combined := printf "%s%s" (.Values.wordpress.configExtra | default "") $inject }}
  WORDPRESS_CONFIG_EXTRA: {{ $combined | b64enc }}
  {{- else }}
  {{/* External source provides user config: store inject separately for K8s $(VAR) interpolation in deployment.yaml */}}
  _WP_CONFIG_INJECT: {{ $inject | b64enc }}
  {{- end }}
  {{- else }}
  {{/* configExtraInject disabled: only include configExtra if set and no external source */}}
  {{- if and .Values.wordpress.configExtra (not .Values.wordpress.configExtraConfigMap.name) (not .Values.wordpress.configExtraSecret.name) }}
  WORDPRESS_CONFIG_EXTRA: {{ .Values.wordpress.configExtra | b64enc }}
  {{- end }}
  {{- end }}
  {{- if .Values.mariadb.enabled }}
  {{- $host := include "wordpress.mariadb.fullname" . }}
  {{- $port := default 3306 .Values.mariadb.service.port }}
  WORDPRESS_DB_NAME: {{ .Values.mariadb.auth.database | b64enc }}
  WORDPRESS_DB_HOST: {{ printf "%s:%v" $host $port | b64enc }}
  WORDPRESS_DB_USER: {{ .Values.mariadb.auth.username | b64enc }}
  {{- else }}
  {{- $host := .Values.externalDatabase.host }}
  {{- $port := default 3306 .Values.externalDatabase.port }}
  WORDPRESS_DB_NAME: {{ .Values.externalDatabase.database | b64enc }}
  WORDPRESS_DB_HOST: {{ printf "%s:%v" $host $port | b64enc }}
  {{- if and (not .Values.mariadb.enabled) (not .Values.externalDatabase.existingSecret) }}
  {{- if .Values.externalDatabase.username }}
  WORDPRESS_DB_USER: {{ .Values.externalDatabase.username | b64enc }}
  {{- end }}
  {{- if .Values.externalDatabase.password }}
  WORDPRESS_DB_PASSWORD: {{ .Values.externalDatabase.password | b64enc }}
  {{- end }}
  {{- end }}
  {{- end }}
{{- if and .Values.wordpress.init.enabled (empty .Values.wordpress.init.existingSecret) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "wordpress.fullname" . }}-init
  namespace: {{ .Release.Namespace }}
  labels:
    release: {{ include "wordpress.fullname" . }}-init
type: Opaque
data:
  wordpress.username: {{ .Values.wordpress.init.username | b64enc }}
  wordpress.password: {{ .Values.wordpress.init.password | b64enc }}
  wordpress.email: {{ .Values.wordpress.init.email | b64enc }}
{{- end }}
{{ if .Values.metrics.wordpress.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "metrics.wordpress.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    release: {{ include "metrics.wordpress.fullname" . }}
type: Opaque
data:
  {{ if (empty .Values.metrics.wordpress.existingSecret) }}
  wordpress.metrics.token: {{ .Values.metrics.wordpress.serviceMonitor.token | b64enc }}
  {{- end }}
  wordpress.metrics.encryptionKey: {{ randAlphaNum 32 | b64enc }}
{{- end }}