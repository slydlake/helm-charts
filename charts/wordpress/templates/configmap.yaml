{{- if or (not .Values.apache.customDefaultSiteConfigMap) (not .Values.apache.customPortsConfigMap) (not .Values.apache.customPhpConfigMap) (not .Values.wordpress.htaccessConfigMap)  }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wordpress.fullname" . }}-configfiles
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "wordpress.labels" . | nindent 4 }}
data:
  {{- if (not .Values.apache.customDefaultSiteConfigMap)  }}
  000-default.conf: |
    {{- if .Values.apache.customDefaultSiteConfig }}
    {{ .Values.apache.customDefaultSiteConfig | nindent 4 }}
    {{- else if .Values.metrics.apache.enabled }}
    <VirtualHost *:{{ .Values.service.ports.http }}>
            ServerAdmin webmaster@localhost
            <Location "/server-status">
                    SetHandler server-status
                    Require local
            </Location>
            DocumentRoot /var/www/html
            ErrorLog ${APACHE_LOG_DIR}/error.log
            CustomLog ${APACHE_LOG_DIR}/access.log combined
    </VirtualHost>
    {{- else }}
    <VirtualHost *:{{ .Values.service.ports.http }}>
            ServerAdmin webmaster@localhost
            DocumentRoot /var/www/html

            ErrorLog ${APACHE_LOG_DIR}/error.log
            CustomLog ${APACHE_LOG_DIR}/access.log combined
    </VirtualHost>
    {{- end }}
  {{- end }}
  {{- if (not .Values.apache.customPortsConfigMap) }}
  ports.conf: |
    {{- if .Values.apache.customPortsConfig }}
    {{ .Values.apache.customPortsConfig | nindent 4 }}
    {{- else }}
    Listen {{ .Values.service.ports.http }}
    {{- end }}
  {{- end }}
  {{- if (not .Values.apache.customPhpConfigMap) }}
  custom.ini: |
    {{- if and .Values.apache.customPhpConfig  (not .Values.apache.customPhpConfigMap) }}
    {{ .Values.apache.customPhpConfig | nindent 4 }}
    {{- end }}
  {{- end }}
  {{- if (not .Values.wordpress.htaccessConfigMap) }}
  htaccess: |
    {{- if and .Values.wordpress.htaccess  (not .Values.wordpress.htaccessConfigMap) }}
    {{ .Values.wordpress.htaccess | nindent 4 }}
    {{ else if .Values.metrics.apache.enabled }}
    # Server-status exception
    <IfModule mod_rewrite.c>
    RewriteRule ^server-status - [L]
    </IfModule>

    # BEGIN WordPress
    # The directives (lines) between "BEGIN WordPress" and "END WordPress" are
    # dynamically generated and will be automatically injected by the init container.
    # Any changes to the directives between these markers will be overwritten.
    # END WordPress
    {{ else }}
    # BEGIN WordPress
    # The directives (lines) between "BEGIN WordPress" and "END WordPress" are
    # dynamically generated and will be automatically injected by the init container.
    # Any changes to the directives between these markers will be overwritten.
    # END WordPress
    {{- end }}
  {{- end }}
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wordpress.fullname" . }}-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "wordpress.labels" . | nindent 4 }}
data:
  base.sh: |
    #!/bin/bash
    # Check if WordPress files exist; if not copy them but exclude wp-content.
    if [ ! -e /tmp/wordpress/index.php ] && [ ! -e /tmp/wordpress/wp-includes/version.php ]; then
        echo "WordPress not found in /tmp/wordpress - copying now..."
        # Use a for loop to copy everything except wp-content
        mkdir -p /tmp/wordpress
        cd /usr/src/wordpress || exit 0
        for item in *; do
          if [ "$item" != "wp-content" ]; then
            cp -r "$item" /tmp/wordpress/ || exit 1
          fi
          # Handle wp-config-docker.php
          if [ "$item" = "wp-config-docker.php" ] && [ ! -s /tmp/wordpress/wp-config.php ]; then
            awk '
              /put your unique phrase here/ {
                cmd = "head -c1m /dev/urandom | sha1sum | cut -d\\  -f1"
                cmd | getline str
                close(cmd)
                gsub("put your unique phrase here", str)
              }
              { print }
            ' "$item" > /tmp/wordpress/wp-config.php
          fi
        done
        
        # Also try to copy any existing wp-content from /var/www/html if present
        if [ ! -d /tmp/wordpress/wp-content ]; then
            cp -r /var/www/html/wp-content /tmp/wordpress/wp-content 2>/dev/null || true
        fi
        echo "Complete! WordPress has been successfully copied to /tmp/wordpress"
    else
        echo "WordPress already present in /tmp/wordpress - skipping copy"
    fi
    
    # ============================================================================
    # Setup MU-Plugins from ConfigMaps
    # ============================================================================
    {{- if .Values.wordpress.muPluginsConfigMaps }}
    echo ""
    echo "Setting up MU-Plugins from ConfigMaps..."
    echo "========================================="
    
    # Create mu-plugins directory if it doesn't exist
    mkdir -p /tmp/wordpress/wp-content/mu-plugins
    chown www-data:www-data /tmp/wordpress/wp-content/mu-plugins
    chmod 755 /tmp/wordpress/wp-content/mu-plugins
    
    {{- range .Values.wordpress.muPluginsConfigMaps }}
    # Copy files from ConfigMap: {{ .name }}
    if [ -d "/tmp/mu-plugins-{{ .name }}" ]; then
      {{- if .key }}
      # Copy specific key only
      if [ -f "/tmp/mu-plugins-{{ .name }}/{{ .key }}" ]; then
        echo "Copying MU-Plugin file {{ .key }} from {{ .name }}..."
        cp /tmp/mu-plugins-{{ .name }}/{{ .key }} /tmp/wordpress/wp-content/mu-plugins/
        chown www-data:www-data /tmp/wordpress/wp-content/mu-plugins/{{ .key }}
        chmod 644 /tmp/wordpress/wp-content/mu-plugins/{{ .key }}
        echo "MU-Plugin file {{ .key }} from {{ .name }} copied successfully!"
      else
        echo "Warning: Key {{ .key }} not found in ConfigMap {{ .name }}"
      fi
      {{- else }}
      # Copy all files from ConfigMap
      echo "Copying all MU-Plugin files from {{ .name }}..."
      cp -r -L /tmp/mu-plugins-{{ .name }}/* /tmp/wordpress/wp-content/mu-plugins/ 2>/dev/null || true
      # Set correct ownership and permissions for all copied files
      find /tmp/wordpress/wp-content/mu-plugins -type f -exec chown www-data:www-data {} \;
      find /tmp/wordpress/wp-content/mu-plugins -type f -exec chmod 644 {} \;
      echo "MU-Plugin files from {{ .name }} copied successfully!"
      {{- end }}
    else
      echo "Warning: MU-Plugin ConfigMap mount {{ .name }} not found"
    fi
    {{- end }}
    
    echo "MU-Plugins setup completed!"
    {{- else }}
    echo "No MU-Plugins ConfigMaps configured."
    {{- end }}
    
    # ============================================================================
    # Custom Init Commands ConfigMap Info
    # ============================================================================
    {{- if .Values.wordpress.init.customInitConfigMap }}
    echo ""
    echo "Custom init commands ConfigMap detected: {{ .Values.wordpress.init.customInitConfigMap }}"
    {{- end }}
    
    echo "========================================="
    echo "Base script completed!"
    echo "========================================="
  htaccess-setup.sh: |
    #!/bin/sh
    # Script to setup .htaccess on persistent volume
    # This runs in the base init container
    
    echo "Starting .htaccess setup..."
    
    # Copy and make injection script executable once
    cp /tmp/scripts/htaccess-inject.sh /tmp/htaccess-inject.sh
    chmod +x /tmp/htaccess-inject.sh
    
    # Check if .htaccess already exists on persistent volume
    if [ ! -f /tmp/wordpress/.htaccess ]; then
      echo ".htaccess not found on persistent volume, creating from ConfigMap..."
      
      # Copy .htaccess from ConfigMap and inject WordPress rules
      /tmp/htaccess-inject.sh \
        /tmp/configfiles/.htaccess \
        /tmp/wordpress/.htaccess \
        /tmp/scripts/wordpress-rewrite-rules.txt
      
      # Set correct ownership and permissions
      chown www-data:www-data /tmp/wordpress/.htaccess
      chmod 664 /tmp/wordpress/.htaccess
      echo "WordPress rewrite rules successfully injected and written to persistent volume!"
    else
      echo ".htaccess already exists on persistent volume."
      
      # Extract WordPress block content from existing file (if it exists)
      if grep -q "# BEGIN WordPress" /tmp/wordpress/.htaccess; then
        echo "Extracting WordPress block content from existing .htaccess..."
        
        # Extract ONLY the content between markers (excluding the markers themselves)
        awk '/# BEGIN WordPress/,/# END WordPress/{if (!/# BEGIN WordPress/ && !/# END WordPress/) print}' /tmp/wordpress/.htaccess > /tmp/wp-block-content.txt
        
        # Start with fresh ConfigMap .htaccess and inject the existing WordPress block content
        /tmp/htaccess-inject.sh \
          /tmp/configfiles/.htaccess \
          /tmp/htaccess-new \
          /tmp/wp-block-content.txt
        
        # Replace old .htaccess with updated one
        mv /tmp/htaccess-new /tmp/wordpress/.htaccess
        chown www-data:www-data /tmp/wordpress/.htaccess
        chmod 664 /tmp/wordpress/.htaccess
        echo "ConfigMap .htaccess updated with existing WordPress block content!"
      else
        echo "No WordPress block found in existing .htaccess."
        
        # Inject default WordPress rules into fresh ConfigMap .htaccess
        /tmp/htaccess-inject.sh \
          /tmp/configfiles/.htaccess \
          /tmp/htaccess-new \
          /tmp/scripts/wordpress-rewrite-rules.txt
        
        # Replace old .htaccess with updated one
        mv /tmp/htaccess-new /tmp/wordpress/.htaccess
        chown www-data:www-data /tmp/wordpress/.htaccess
        chmod 664 /tmp/wordpress/.htaccess
        echo "ConfigMap .htaccess applied with default WordPress rules!"
      fi
    fi
    
    echo "========================================="
    echo ".htaccess setup completed!"
    echo "========================================="
  wordpress-rewrite-rules.txt: |
    <IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    RewriteBase /
    RewriteRule ^index\.php$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.php [L]
    </IfModule>
  htaccess-inject.sh: |
    #!/bin/sh
    # Script to inject WordPress rewrite rules into .htaccess
    # Usage: htaccess-inject.sh <source-htaccess> <output-htaccess> <rules-file>
    
    SOURCE_FILE="$1"
    OUTPUT_FILE="$2"
    RULES_FILE="$3"
    
    awk -v rules_file="$RULES_FILE" '
    BEGIN { 
        in_wp=0
        wp_done=0
        # Read rules from file
        while ((getline line < rules_file) > 0) {
            rules = rules line "\n"
        }
        close(rules_file)
    }
    /# BEGIN WordPress/ { 
        print
        printf "%s", rules
        in_wp=1
        wp_done=1
        next
    }
    /# END WordPress/ { in_wp=0 }
    !in_wp || !wp_done { print }
    ' "$SOURCE_FILE" > "$OUTPUT_FILE"
  init.sh: |
    #!/bin/bash
    set -e
    
    echo "Starting init script..."
    
    # ============================================================================
    # Configuration
    # ============================================================================
    CHECK_INTERVAL=5
    STALE_LOCK_THRESHOLD=120  # Consider lock stale after 2 minutes (handles pod deletion)
    MAX_WAIT=$((STALE_LOCK_THRESHOLD + 30))  # Wait a bit longer than stale threshold
    WAIT_TIME=0
    
    # ============================================================================
    # Database Lock Functions
    # Uses WordPress options table as distributed lock across all pods
    # ============================================================================
    
    claim_lock_db() {
      CURRENT_TIME=$(date +%s)
      POD_ID="$$-$(hostname)"
      
      # Get table prefix dynamically
      TABLE_PREFIX=$(wp db prefix 2>/dev/null || echo "wp_")
      [ "${DEBUG}" = "true" ] && echo "DEBUG: Using table prefix: $TABLE_PREFIX" >&2
      [ "${DEBUG}" = "true" ] && echo "DEBUG: Attempting to claim lock with POD_ID=$POD_ID-$CURRENT_TIME" >&2
      
      # Check if wp_options table exists - if not, it's a fresh install
      if ! wp db query "SHOW TABLES LIKE '${TABLE_PREFIX}options';" --skip-column-names 2>/dev/null | grep -q "${TABLE_PREFIX}options"; then
        [ "${DEBUG}" = "true" ] && echo "DEBUG: wp_options table doesn't exist yet, claiming lock for fresh install" >&2
        return 0
      fi
      
      # Try to insert lock row - ignore error if already exists
      wp db query "INSERT IGNORE INTO ${TABLE_PREFIX}options (option_name, option_value, autoload) VALUES ('_helm_init_lock', '$POD_ID-$CURRENT_TIME', 'no');" >/dev/null 2>&1
      INSERT_RESULT=$?
      [ "${DEBUG}" = "true" ] && echo "DEBUG: INSERT result: $INSERT_RESULT" >&2
      
      # Check if we actually got the lock
      LOCK_OWNER=$(wp db query "SELECT option_value FROM ${TABLE_PREFIX}options WHERE option_name='_helm_init_lock';" --skip-column-names 2>/dev/null || echo "")
      [ "${DEBUG}" = "true" ] && echo "DEBUG: Current lock owner: $LOCK_OWNER" >&2
      
      if [[ "$LOCK_OWNER" == "$POD_ID-$CURRENT_TIME" ]]; then
        [ "${DEBUG}" = "true" ] && echo "DEBUG: Successfully claimed lock!" >&2
        return 0
      fi
      
      # Check for stale lock (older than threshold)
      LOCK_TIME=$(echo "$LOCK_OWNER" | awk -F'-' '{print $NF}')
      if [[ "$LOCK_TIME" =~ ^[0-9]+$ ]]; then
        LOCK_AGE=$((CURRENT_TIME - LOCK_TIME))
        [ "${DEBUG}" = "true" ] && echo "DEBUG: Lock age: ${LOCK_AGE}s (threshold: ${STALE_LOCK_THRESHOLD}s)" >&2
        if [ $LOCK_AGE -gt $STALE_LOCK_THRESHOLD ]; then
          echo "Found stale lock (${LOCK_AGE}s old), taking over..." >&2
          wp db query "UPDATE ${TABLE_PREFIX}options SET option_value='$POD_ID-$CURRENT_TIME' WHERE option_name='_helm_init_lock';" >/dev/null 2>&1
          return 0
        fi
      else
        [ "${DEBUG}" = "true" ] && echo "DEBUG: Lock time is not numeric: $LOCK_TIME" >&2
      fi
      
      return 1
    }
    
    release_lock() {
      TABLE_PREFIX=$(wp db prefix 2>/dev/null || echo "wp_")
      wp db query "DELETE FROM ${TABLE_PREFIX}options WHERE option_name='_helm_init_lock';" >/dev/null 2>&1 || true
      echo "Lock released"
    }
    
    trap release_lock EXIT
    
    # ============================================================================
    # Helper Functions
    # ============================================================================
    
    # WP-CLI wrapper with optional debug output
    wp() {
      if [ "${DEBUG}" = "true" ]; then
        command wp --path="${WORDPRESS_PATH}" --debug "$@"
      else
        command wp --path="${WORDPRESS_PATH}" "$@"
      fi
    }

    # Run commands with optional output suppression
    run() {
      if [ "${DEBUG}" = "true" ]; then
        "$@"
      else
        "$@" >/dev/null 2>&1
      fi
    }
    
    # ============================================================================
    # Wait for Database
    # ============================================================================
    
    echo "Waiting for database..."
    until run wp db check; do
      echo "Database not ready yet, waiting 15 seconds..."
      sleep 15
    done
    
    # ============================================================================
    # WordPress Installation (First-Time Only)
    # ============================================================================
    
    if [ "${WP_INIT}" = "true" ]; then
      if ! run wp core is-installed --url="${WP_URL}"; then
        echo "Setting up WordPress..."
        run wp core install \
          --url="${WP_URL}" \
          --title="${WP_TITLE}" \
          --admin_user="${WP_ADMIN_USER}" \
          --admin_password="${WP_ADMIN_PASSWORD}" \
          --admin_email="${WP_ADMIN_EMAIL}" \
          --skip-email \
          --locale="${WP_LOCALE}"
      else
        echo "WordPress is already installed, skipping installation."
      fi
    else
      # WP_INIT is false - check if WordPress is already installed
      TABLE_PREFIX=$(wp db prefix 2>/dev/null || echo "wp_")
      
      # Check if wp_options table exists
      if ! wp db query "SHOW TABLES LIKE '${TABLE_PREFIX}options';" --skip-column-names 2>/dev/null | grep -q "${TABLE_PREFIX}options"; then
        echo "========================================="
        echo "ERROR: WordPress database tables not found!"
        echo "========================================="
        echo ""
        echo "The database exists but WordPress tables are missing."
        echo "This indicates one of the following issues:"
        echo ""
        echo "1. WordPress initialization has not been performed yet"
        echo "   -> Set wordpress.init.enabled=true in your values.yaml"
        echo ""
        echo "2. Wrong table prefix configured"
        echo "   -> Current prefix: ${TABLE_PREFIX}"
        echo "   -> Check wordpress.tablePrefix in your values.yaml"
        echo ""
        echo "3. Database was reset but persistent volume still exists"
        echo "   -> Delete the PVC and reinstall"
        echo ""
        echo "========================================="
        exit 1
      fi
      
      echo "WordPress tables found, continuing with configuration..."
    fi
    
    # ============================================================================
    # Acquire Database Lock
    # Ensures only one pod performs initialization at a time
    # ============================================================================
    
    echo "Acquiring database lock for initialization..."
    while ! claim_lock_db; do
      if [ $WAIT_TIME -ge $MAX_WAIT ]; then
        echo "Timeout waiting for database lock after ${MAX_WAIT}s"
        
        # Final attempt to forcefully claim the lock
        POD_ID="$$-$(hostname)"
        CURRENT_TIME=$(date +%s)
        TABLE_PREFIX=$(wp db prefix 2>/dev/null || echo "wp_")
        wp db query "UPDATE ${TABLE_PREFIX}options SET option_value='$POD_ID-$CURRENT_TIME' WHERE option_name='_helm_init_lock';" >/dev/null 2>&1 || \
        wp db query "INSERT INTO ${TABLE_PREFIX}options (option_name, option_value, autoload) VALUES ('_helm_init_lock', '$POD_ID-$CURRENT_TIME', 'no');" >/dev/null 2>&1
        
        # Verify we actually got it
        sleep 1
        LOCK_OWNER=$(wp db query "SELECT option_value FROM ${TABLE_PREFIX}options WHERE option_name='_helm_init_lock';" --skip-column-names 2>/dev/null || echo "")
        if [[ "$LOCK_OWNER" == "$POD_ID-$CURRENT_TIME" ]]; then
          echo "Successfully claimed lock after timeout"
          break
        else
          echo "Failed to claim lock - another pod won. Exiting to avoid conflicts."
          exit 1
        fi
      fi
      
      echo "Another pod is currently running init process, waiting... (${WAIT_TIME}s/${MAX_WAIT}s)"
      sleep $CHECK_INTERVAL
      WAIT_TIME=$((WAIT_TIME + CHECK_INTERVAL))
    done

    echo "Database lock acquired, proceeding with initialization..."
    
    # ============================================================================
    # WordPress Configuration (Localization, Permalinks, User Metadata)
    # ============================================================================
    
    if [ "${WP_INIT}" = "true" ]; then
      # Set language
      if [ -n "${WP_LOCALE}" ]; then
        LANG_STATUS=$(wp language core list --language=${WP_LOCALE} --field=status)
        case $LANG_STATUS in
          "uninstalled")
            wp language core install ${WP_LOCALE} --activate
            ;;
          "installed")
            wp site switch-language ${WP_LOCALE}
            ;;
        esac
      fi

      # Set permalinks
      if [ -n "${WP_PERMALINK_STRUCTURE}" ]; then
        echo "Setting WordPress permalinks..."
        wp rewrite structure "${WP_PERMALINK_STRUCTURE}"
        wp rewrite flush
      fi

      # Set admin user metadata
      if [ -n "${WP_ADMIN_FIRSTNAME}" ]; then
        CURRENT_FIRSTNAME=$(wp user meta get "$WP_ADMIN_USER" first_name 2>/dev/null || echo "")
        if [ "$CURRENT_FIRSTNAME" != "$WP_ADMIN_FIRSTNAME" ]; then
          echo "Setting admin first name..."
          wp user meta update "$WP_ADMIN_USER" first_name "$WP_ADMIN_FIRSTNAME"
        fi
      fi
      if [ -n "${WP_ADMIN_LASTNAME}" ]; then
        CURRENT_LASTNAME=$(wp user meta get "$WP_ADMIN_USER" last_name 2>/dev/null || echo "")
        if [ "$CURRENT_LASTNAME" != "$WP_ADMIN_LASTNAME" ]; then
          echo "Setting admin last name..."
          wp user meta update "$WP_ADMIN_USER" last_name "$WP_ADMIN_LASTNAME"
        fi
      fi
    fi
    
    # ============================================================================
    # Create Custom Users
    # ============================================================================
    
    {{- if .Values.wordpress.users }}
    echo "Creating custom users..."
    EXISTING_USERS=$(wp user list --field=user_login 2>/dev/null || echo "")
    
    {{- range .Values.wordpress.users }}
    if ! echo "$EXISTING_USERS" | grep -q "^{{ .username }}$"; then
      echo "Creating user {{ .username }}..."
      run wp user create "{{ .username }}" "{{ .email }}" \
        --role="{{ .role }}" \
        --display_name="{{ .displayname }}" \
        --first_name="{{ .firstname }}" \
        --last_name="{{ .lastname }}" \
        --send-email="{{ .sendEmail }}"
    else
      echo "User {{ .username }} already exists, skipping."
    fi
    {{- end }}
    {{- else }}
    echo "No custom users specified."
    {{- end }}
    
    # ============================================================================
    # Plugin Management
    # ============================================================================
    
    # Cache all plugin data upfront for performance
    INSTALLED_PLUGINS=$(wp plugin list --field=name 2>/dev/null || echo "")
    ACTIVE_PLUGINS=$(wp plugin list --status=active --field=name 2>/dev/null || echo "")
    AUTOUPDATE_ENABLED=$(wp plugin list --fields=name,auto_update --format=csv 2>/dev/null | grep ",on$" | cut -d',' -f1 || echo "")

    # Handle metrics plugin
    if [ -n "${WORDPRESS_METRICS}" ]; then
      if echo "$INSTALLED_PLUGINS" | grep -q "^${WORDPRESS_METRICS}$"; then
        if ! echo "$ACTIVE_PLUGINS" | grep -q "^${WORDPRESS_METRICS}$"; then
          run wp plugin activate ${WORDPRESS_METRICS}
          ACTIVE_PLUGINS=$(wp plugin list --status=active --field=name 2>/dev/null || echo "")
        fi
      else
        echo "Installing WordPress metrics plugin..."
        wp plugin install ${WORDPRESS_METRICS} --activate --force
        INSTALLED_PLUGINS=$(wp plugin list --field=name 2>/dev/null || echo "")
        ACTIVE_PLUGINS=$(wp plugin list --status=active --field=name 2>/dev/null || echo "")
      fi

      echo "Flushing rewrite rules for metrics plugin..."
      run wp rewrite flush

      if ! echo "$AUTOUPDATE_ENABLED" | grep -q "^${WORDPRESS_METRICS}$"; then
        run wp plugin auto-updates enable ${WORDPRESS_METRICS}
        AUTOUPDATE_ENABLED=$(wp plugin list --fields=name,auto_update --format=csv 2>/dev/null | grep ",on$" | cut -d',' -f1 || echo "")
      fi
    else
      # Remove plugin if WORDPRESS_METRICS is empty and plugin exists
      if [ -n "${WORDPRESS_METRICS}" ] && [ -n "$INSTALLED_PLUGINS" ] && echo "$INSTALLED_PLUGINS" | grep -q "^${WORDPRESS_METRICS}$"; then
        echo "Removing metrics plugin..."
        wp plugin delete ${WORDPRESS_METRICS}
        INSTALLED_PLUGINS=$(wp plugin list --field=name 2>/dev/null || echo "")
      fi
    fi

    # Handle custom plugins
    {{- if .Values.wordpress.plugins }}
    echo "Installing custom plugins..."
    
    PLUGINS_TO_INSTALL=()
    PLUGINS_TO_ACTIVATE=()
    PLUGINS_TO_AUTOUPDATE=()
    
    {{- range .Values.wordpress.plugins }}
    # Plugin: {{ .name }}
    PLUGIN_NAME="{{ .name }}"
    
    # Check if it's a URL (at runtime, not template time)
    if [[ "$PLUGIN_NAME" == http://* ]] || [[ "$PLUGIN_NAME" == https://* ]]; then
      echo "Installing URL plugin: $PLUGIN_NAME"
      {{- if .activate }}
      run wp plugin install "$PLUGIN_NAME" --activate --force
      {{- else }}
      run wp plugin install "$PLUGIN_NAME" --force
      {{- end }}
      # Note: Auto-updates for URL plugins are skipped (slug cannot be reliably determined)
    else
      # Named plugin - add to batch processing
      if ! echo "$INSTALLED_PLUGINS" | grep -q "^${PLUGIN_NAME}$"; then
        {{- if .version }}
        PLUGINS_TO_INSTALL+=("{{ .name }}:{{ .version }}")
        {{- else }}
        PLUGINS_TO_INSTALL+=("{{ .name }}")
        {{- end }}
      fi
      {{- if .activate }}
      PLUGINS_TO_ACTIVATE+=("{{ .name }}")
      {{- end }}
      {{- if .autoupdate }}
      PLUGINS_TO_AUTOUPDATE+=("{{ .name }}")
      {{- end }}
    fi
    {{- end }}

    # Batch install plugins
    if [ ${#PLUGINS_TO_INSTALL[@]} -gt 0 ]; then
      echo "Installing ${#PLUGINS_TO_INSTALL[@]} plugin(s)..."
      
      PLUGINS_NO_VERSION=()
      PLUGINS_WITH_VERSION=()
      
      for plugin_spec in "${PLUGINS_TO_INSTALL[@]}"; do
        if [[ "$plugin_spec" == *":"* ]]; then
          PLUGINS_WITH_VERSION+=("$plugin_spec")
        else
          PLUGINS_NO_VERSION+=("$plugin_spec")
        fi
      done
      
      if [ ${#PLUGINS_NO_VERSION[@]} -gt 0 ]; then
        wp plugin install "${PLUGINS_NO_VERSION[@]}" --force
      fi
      
      for plugin_spec in "${PLUGINS_WITH_VERSION[@]}"; do
        PLUGIN_NAME="${plugin_spec%%:*}"
        PLUGIN_VERSION="${plugin_spec##*:}"
        wp plugin install "${PLUGIN_NAME}" --version="${PLUGIN_VERSION}" --force
      done
      
      INSTALLED_PLUGINS=$(wp plugin list --field=name 2>/dev/null || echo "")
      ACTIVE_PLUGINS=$(wp plugin list --status=active --field=name 2>/dev/null || echo "")
    fi

    # Batch activate plugins
    if [ ${#PLUGINS_TO_ACTIVATE[@]} -gt 0 ]; then
      PLUGINS_NEED_ACTIVATION=()
      for plugin in "${PLUGINS_TO_ACTIVATE[@]}"; do
        if ! echo "$ACTIVE_PLUGINS" | grep -q "^${plugin}$"; then
          PLUGINS_NEED_ACTIVATION+=("$plugin")
        fi
      done
      
      if [ ${#PLUGINS_NEED_ACTIVATION[@]} -gt 0 ]; then
        echo "Activating ${#PLUGINS_NEED_ACTIVATION[@]} plugin(s)..."
        run wp plugin activate "${PLUGINS_NEED_ACTIVATION[@]}"
        ACTIVE_PLUGINS=$(wp plugin list --status=active --field=name 2>/dev/null || echo "")
      fi
    fi

    # Batch enable auto-updates
    if [ ${#PLUGINS_TO_AUTOUPDATE[@]} -gt 0 ]; then
      PLUGINS_NEED_AUTOUPDATE=()
      for plugin in "${PLUGINS_TO_AUTOUPDATE[@]}"; do
        if ! echo "$AUTOUPDATE_ENABLED" | grep -q "^${plugin}$"; then
          PLUGINS_NEED_AUTOUPDATE+=("$plugin")
        fi
      done
      
      if [ ${#PLUGINS_NEED_AUTOUPDATE[@]} -gt 0 ]; then
        echo "Enabling auto-updates for ${#PLUGINS_NEED_AUTOUPDATE[@]} plugin(s)..."
        run wp plugin auto-updates enable "${PLUGINS_NEED_AUTOUPDATE[@]}"
      fi
    fi
    {{- else }}
    echo "No custom plugins specified."
    {{- end }}
    
    # ============================================================================
    # Theme Management
    # ============================================================================
    
    {{- if .Values.wordpress.themes }}
    echo "Installing custom themes..."
    
    # Cache all theme data upfront
    INSTALLED_THEMES=$(wp theme list --field=name 2>/dev/null || echo "")
    ACTIVE_THEME=$(wp theme list --status=active --field=name 2>/dev/null || echo "")
    AUTOUPDATE_ENABLED_THEMES=$(wp theme list --fields=name,auto_update --format=csv 2>/dev/null | grep ",on$" | cut -d',' -f1 || echo "")
    
    # Extract theme slug from name/URL
    get_theme_slug() {
      local theme_name="$1"
      if [[ "$theme_name" == *".zip" ]]; then
        basename "$theme_name" .zip
      else
        echo "$theme_name"
      fi
    }
    
    THEMES_TO_INSTALL=()
    THEME_TO_ACTIVATE=""
    THEMES_TO_AUTOUPDATE=()
    
    {{- range .Values.wordpress.themes }}
    THEME_SLUG=$(get_theme_slug "{{ .name }}")

    if ! echo "$INSTALLED_THEMES" | grep -q "^${THEME_SLUG}$"; then
      {{- if .version }}
      THEMES_TO_INSTALL+=("{{ .name }}:{{ .version }}")
      {{- else }}
      THEMES_TO_INSTALL+=("{{ .name }}")
      {{- end }}
    fi
    {{- if .activate }}
    THEME_TO_ACTIVATE="${THEME_SLUG}"
    {{- end }}
    {{- if .autoupdate }}
    THEMES_TO_AUTOUPDATE+=("${THEME_SLUG}")
    {{- end }}
    {{- end }}

    # Batch install themes
    if [ ${#THEMES_TO_INSTALL[@]} -gt 0 ]; then
      echo "Installing ${#THEMES_TO_INSTALL[@]} theme(s)..."
      
      THEMES_SIMPLE=()
      THEMES_URLS=()
      THEMES_WITH_VERSION=()
      
      for theme_spec in "${THEMES_TO_INSTALL[@]}"; do
        if [[ "$theme_spec" == http://* ]] || [[ "$theme_spec" == https://* ]]; then
          THEMES_URLS+=("$theme_spec")
        elif [[ "$theme_spec" == *":"* ]]; then
          THEMES_WITH_VERSION+=("$theme_spec")
        else
          THEMES_SIMPLE+=("$theme_spec")
        fi
      done
      
      if [ ${#THEMES_SIMPLE[@]} -gt 0 ]; then
        wp theme install "${THEMES_SIMPLE[@]}" --force
      fi
      
      for theme_url in "${THEMES_URLS[@]}"; do
        echo "Installing theme from URL: $theme_url"
        wp theme install "$theme_url" --force
      done
      
      for theme_spec in "${THEMES_WITH_VERSION[@]}"; do
        THEME_NAME="${theme_spec%%:*}"
        THEME_VERSION="${theme_spec##*:}"
        echo "Installing theme ${THEME_NAME} version ${THEME_VERSION}..."
        wp theme install "${THEME_NAME}" --version="${THEME_VERSION}" --force
      done
      
      INSTALLED_THEMES=$(wp theme list --field=name 2>/dev/null || echo "")
      ACTIVE_THEME=$(wp theme list --status=active --field=name 2>/dev/null || echo "")
    fi

    # Activate theme
    if [ -n "$THEME_TO_ACTIVATE" ] && [ "$ACTIVE_THEME" != "$THEME_TO_ACTIVATE" ]; then
      echo "Activating theme: $THEME_TO_ACTIVATE"
      run wp theme activate "$THEME_TO_ACTIVATE"
    fi

    # Batch enable auto-updates
    if [ ${#THEMES_TO_AUTOUPDATE[@]} -gt 0 ]; then
      THEMES_NEED_AUTOUPDATE=()
      for theme in "${THEMES_TO_AUTOUPDATE[@]}"; do
        if ! echo "$AUTOUPDATE_ENABLED_THEMES" | grep -q "^${theme}$"; then
          THEMES_NEED_AUTOUPDATE+=("$theme")
        fi
      done
      
      if [ ${#THEMES_NEED_AUTOUPDATE[@]} -gt 0 ]; then
        echo "Enabling auto-updates for ${#THEMES_NEED_AUTOUPDATE[@]} theme(s)..."
        run wp theme auto-updates enable "${THEMES_NEED_AUTOUPDATE[@]}"
      fi
    fi
    {{- else }}
    echo "No custom themes specified."
    {{- end }}
    echo "WordPress initialization completed!"
    
    # ============================================================================
    # Custom Init Commands
    # ============================================================================
    {{- if .Values.wordpress.init.customInitConfigMap }}
    
    echo "Running custom init commands from ConfigMap..."
    echo "========================================="
    if [ -f /tmp/custom-init-commands/{{ .Values.wordpress.init.customInitConfigMapKey | default "commands.sh" }} ]; then
      # Execute the custom commands script (already executable via defaultMode: 0755)
      /tmp/custom-init-commands/{{ .Values.wordpress.init.customInitConfigMapKey | default "commands.sh" }}
      echo "========================================="
      echo "Custom init commands completed!"
    else
      echo "Warning: Custom commands file not found in ConfigMap"
    fi
    {{- else }}
    echo "No custom init commands configured."
    {{- end }}
    
    # ============================================================================
    # Release Lock and Complete
    # ============================================================================
    
    # Lock will be released automatically via trap on EXIT
    echo "Init script completed!"