{{- if or (not .Values.apache.customDefaultSiteConfigMap) (not .Values.apache.customPortsConfigMap) (not .Values.apache.customPhpConfigMap) (not .Values.wordpress.htaccessConfigMap)  }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wordpress.fullname" . }}-configfiles
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "wordpress.labels" . | nindent 4 }}
data:
  {{- if (not .Values.apache.customDefaultSiteConfigMap)  }}
  000-default.conf: |
    {{- if .Values.apache.customDefaultSiteConfig }}
    {{ .Values.apache.customDefaultSiteConfig | nindent 4 }}
    {{- else if .Values.metrics.apache.enabled }}
    <VirtualHost *:{{ .Values.containerPorts.http }}>
            ServerAdmin webmaster@localhost
            <Location "/server-status">
                    SetHandler server-status
                    Require local
            </Location>
            DocumentRoot /var/www/html
            ErrorLog ${APACHE_LOG_DIR}/error.log
            CustomLog ${APACHE_LOG_DIR}/access.log combined
    </VirtualHost>
    {{- else }}
    <VirtualHost *:{{ .Values.containerPorts.http }}>
            ServerAdmin webmaster@localhost
            DocumentRoot /var/www/html

            ErrorLog ${APACHE_LOG_DIR}/error.log
            CustomLog ${APACHE_LOG_DIR}/access.log combined
    </VirtualHost>
    {{- end }}
  {{- end }}
  {{- if (not .Values.apache.customPortsConfigMap) }}
  ports.conf: |
    {{- if .Values.apache.customPortsConfig }}
    {{ .Values.apache.customPortsConfig | nindent 4 }}
    {{- else }}
    Listen {{ .Values.containerPorts.http }}
    {{- end }}
  {{- end }}
  {{- if (not .Values.apache.customPhpConfigMap) }}
  custom.ini: |
    {{- if and .Values.apache.customPhpConfig  (not .Values.apache.customPhpConfigMap) }}
    {{ .Values.apache.customPhpConfig | nindent 4 }}
    {{- end }}
  {{- end }}
  {{- if (not .Values.wordpress.htaccessConfigMap) }}
  htaccess: |
    {{- if and .Values.wordpress.htaccess  (not .Values.wordpress.htaccessConfigMap) }}
    {{ .Values.wordpress.htaccess | nindent 4 }}
    {{ else if .Values.metrics.apache.enabled }}
    # Server-status exception
    <IfModule mod_rewrite.c>
    RewriteRule ^server-status - [L]
    </IfModule>

    # BEGIN WordPress
    # The directives (lines) between "BEGIN WordPress" and "END WordPress" are
    # dynamically generated and will be automatically injected by the init container.
    # Any changes to the directives between these markers will be overwritten.
    # END WordPress
    {{ else }}
    # BEGIN WordPress
    # The directives (lines) between "BEGIN WordPress" and "END WordPress" are
    # dynamically generated and will be automatically injected by the init container.
    # Any changes to the directives between these markers will be overwritten.
    # END WordPress
    {{- end }}
  {{- end }}
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wordpress.fullname" . }}-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "wordpress.labels" . | nindent 4 }}
data:
  base.sh: |
    {{- include "wordpress.init-base" . | nindent 4 }}
  htaccess-setup.sh: |
    {{- include "wordpress.init-htaccess-setup" . | nindent 4 }}
  wordpress-rewrite-rules.txt: |
    {{- include "wordpress.init-htaccess-rewrite-rules" . | nindent 4 }}
  htaccess-inject.sh: |
    {{- include "wordpress.init-htaccess-inject" . | nindent 4 }}
  # ============================================================================
  # Library: Core Functions (lib-core.sh)
  # ============================================================================
  # Contains: wp(), run(), handle_error(), retry_command(), validate_package_name(), assert()
  # Used by: init.sh
  lib-core.sh: |
    {{- include "wordpress.init-lib-core" . | nindent 4 }}
  # ============================================================================
  # Library: Database Lock Functions (lib-lock.sh)
  # ============================================================================
  # Contains: claim_bootstrap_lock(), release_bootstrap_lock(), claim_config_lock(), release_config_lock()
  # Provides distributed locking for multi-pod deployments using database tables
  # Uses heartbeat mechanism: lock holder updates timestamp every 15s,
  # waiters consider lock stale if no heartbeat for 60s
  lib-lock.sh: |
    {{- include "wordpress.init-lib-lock" . | nindent 4 }}
  # ============================================================================
  # Library: Composer Functions (lib-composer.sh)
  # ============================================================================
  # Contains: ensure_composer(), composer_exec()
  # Handles Composer installation and package management
  lib-composer.sh: |
    {{- include "wordpress.init-lib-composer" . | nindent 4 }}
  init.sh: |
    {{- include "wordpress.init-script" . | nindent 4 }}
